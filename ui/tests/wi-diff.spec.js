import { normalizeHtml, test } from "./test-utils";
import { expect } from "@playwright/test";

// Helper functions
async function closeModalIfVisible(page, modalTestId, closeButtonSelector) {
  const modal = page.getByTestId(modalTestId);
  if (await modal.isVisible()) {
    const closeButton = modal.locator(closeButtonSelector);
    await closeButton.click();
    await expect(modal).not.toBeVisible();
  }
}

async function handleMergeRequest(page, checkboxTestId, mergeButtonIndex, confirm = false) {
  const selectionCheckbox = page.getByTestId(checkboxTestId).locator('.merge-ticker input[type="checkbox"]');
  await selectionCheckbox.isVisible();
  await selectionCheckbox.click();

  const mergeButton = page.locator('.header .merge-pane .merge-button .btn').nth(mergeButtonIndex);
  await expect(mergeButton).toBeEnabled();
  await mergeButton.click();

  await expect(page.getByTestId("merge-confirmation-modal")).toBeVisible();

  if (confirm) {
    const confirmButton = page.getByTestId("merge-confirmation-modal-action-button");
    await expect(confirmButton).toBeVisible();
    await expect(confirmButton).toBeEnabled();
    await confirmButton.click();
  } else {
    const cancelButton = page.getByTestId("merge-confirmation-modal-cancel-button");
    await expect(cancelButton).toBeVisible();
    await expect(cancelButton).toBeEnabled();
    await cancelButton.click();
  }

  await expect(page.getByTestId("merge-confirmation-modal")).toBeVisible({ visible: false });
}

test.describe("page of diffing WorkItems WorkItems", () => {
  test.beforeEach(async ({ page, mockApi }) => {
    await mockApi.mockEndpoint({ url: '**/extension/info', fixtureFile: 'version-info.json' });
    await mockApi.mockEndpoint({ url: '**/communication/settings', fixtureFile: 'communication-settings.json' });
    await mockApi.mockEndpoint({ url: '**/settings/diff/names?scope=project/elibrary/', fixtureFile: 'configs.json' });
    await mockApi.mockEndpoint({ url: '**/diff/workitems-pairs', fixtureFile: 'workItems-pairs.json' });
    await mockApi.mockEndpoint({ url: '**/diff/detached-workitems', fixtureFile: 'detached-workitems.json' });

    await page.goto('/workitems?sourceProjectId=elibrary&targetProjectId=elibrary&linkRole=relates_to&configuration=Default&sourceRecordsPerPage=20&sourcePage=1&config=Default&ids=1');
  });

  test('workitems-pairs request', async ({ page }) => {
    const diffPostRequestPromise = page.waitForRequest(request => {
      return request.url().includes('/diff/workitems-pairs') && request.method() === "POST";
    });

    const diffPostRequest = await diffPostRequestPromise;
    const postData = JSON.parse(diffPostRequest.postData() || '{}');
    expect(postData.leftProjectId).toBe("elibrary");
    expect(postData.rightProjectId).toBe("elibrary");
    expect(postData.linkRole).toBe("relates_to");
  });

  test('renders headers and floating button with diffs', async ({ page }) => {
    await expect(page.locator('.wi-diff')).toBeVisible();
    await expect(page.getByTestId('left-wi')).toBeVisible();
    await expect(page.getByTestId('right-wi')).toBeVisible();

    const selectAllLabel = page.locator('.header .merge-pane label.select-all');
    await expect(selectAllLabel).toBeVisible();
    await expect(selectAllLabel).toHaveText("select all");

    const selectAllCheckbox = page.locator('.header .merge-pane label.select-all input[type="checkbox"]');
    await expect(selectAllCheckbox).toBeVisible();
    await expect(selectAllCheckbox).toBeChecked({ checked: false });

    const mergeButtons = page.locator('.header .merge-pane .merge-button .btn');
    await expect(mergeButtons).toHaveCount(2);

    const redundancyModal = page.getByTestId('redundancy-modal');
    await expect(redundancyModal).toBeVisible();

    const modalTitle = redundancyModal.locator('text=Redundant counterpart WorkItems');
    await expect(modalTitle).toBeVisible();

    const listItems = redundancyModal.locator('ul > li');
    await expect(listItems).toHaveCount(1);
    await expect(listItems.first()).toHaveText('EL-1');

    await closeModalIfVisible(page, 'redundancy-modal', 'button:has-text("Close")');

    const visibleChange = page.getByTestId('Description');
    await expect(visibleChange.locator(".diff-viewer")).toBeVisible();

    const diffLeft = visibleChange.locator(".diff-viewer .diff-leaf.left");
    await expect(diffLeft).toBeVisible();
    const diffLeftHtml = await diffLeft.innerHTML();
    expect(normalizeHtml(diffLeftHtml)).toBe(normalizeHtml("<span style=\"font-weight: bold;\">Test Run:</span><span style=\"white-space:nowrap;\"><span class=\"diff-html-added\" id=\"removed-diff-0\" previous=\"first-diff\" changeid=\"removed-diff-0\" next=\"added-diff-0\"><img src=\"/polarion/icons/default/enums/testrun_status_passed.png\" md5=\"c9b528b9541e127967eda62f79118ef0\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\" changetype=\"diff-removed-image\"></span></span><span class=\"diff-html-added\" previous=\"first-diff\" changeid=\"removed-diff-0\" next=\"added-diff-0\">0</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"build_all-20170211-235702\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"build_all-20170211-235702 - xUnit Build Test 1.0 I3\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=build_all-20170211-235702\"><span style=\"white-space:nowrap;\"><span class=\"diff-html-removed\" id=\"added-diff-0\" previous=\"removed-diff-0\" changeid=\"added-diff-0\" next=\"changed-diff-0\"><img src=\"/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\" changetype=\"diff-added-image\"></span></span><span class=\"diff-html-removed\" previous=\"removed-diff-0\" changeid=\"added-diff-0\" next=\"changed-diff-0\">build</span><span class=\"diff-html-changed\" id=\"changed-diff-0\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title 0_9b UAT - User <br/>Acceptance Test 0.9b.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title build_all-20170211-235702 - xUnit Build Test <br/>1.0 I3.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li></ul>\" previous=\"added-diff-0\" changeid=\"changed-diff-0\" next=\"removed-diff-1\">_</span></a></span></span><span class=\"diff-html-added\" id=\"removed-diff-1\" previous=\"changed-diff-0\" changeid=\"removed-diff-1\" next=\"added-diff-1\">9b UAT </span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"build_all-20170211-235702\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"build_all-20170211-235702 - xUnit Build Test 1.0 I3\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=build_all-20170211-235702\"><span class=\"diff-html-removed\" id=\"added-diff-1\" previous=\"removed-diff-1\" changeid=\"added-diff-1\" next=\"changed-diff-1\">all</span><span class=\"diff-html-changed\" id=\"changed-diff-1\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title 0_9b UAT - User <br/>Acceptance Test 0.9b.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title build_all-20170211-235702 - xUnit Build Test <br/>1.0 I3.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li></ul>\" previous=\"added-diff-1\" changeid=\"changed-diff-1\" next=\"removed-diff-2\">-</span></a></span></span><span class=\"diff-html-added\" previous=\"changed-diff-1\" changeid=\"removed-diff-2\" next=\"added-diff-2\"></span><span class=\"diff-html-added\" id=\"removed-diff-2\" previous=\"changed-diff-1\" changeid=\"removed-diff-2\" next=\"added-diff-2\">User Acceptance </span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"build_all-20170211-235702\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"build_all-20170211-235702 - xUnit Build Test 1.0 I3\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=build_all-20170211-235702\"><span class=\"diff-html-removed\" id=\"added-diff-2\" previous=\"removed-diff-2\" changeid=\"added-diff-2\" next=\"changed-diff-2\">20170211-235702 - xUnit Build </span><span class=\"diff-html-changed\" id=\"changed-diff-2\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title 0_9b UAT - User <br/>Acceptance Test 0.9b.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title build_all-20170211-235702 - xUnit Build Test <br/>1.0 I3.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li></ul>\" previous=\"added-diff-2\" changeid=\"changed-diff-2\" next=\"added-diff-3\">Test </span><span class=\"diff-html-removed\" id=\"added-diff-3\" previous=\"changed-diff-2\" changeid=\"added-diff-3\" next=\"changed-diff-3\">1.</span><span class=\"diff-html-changed\" id=\"changed-diff-3\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title 0_9b UAT - User <br/>Acceptance Test 0.9b.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title build_all-20170211-235702 - xUnit Build Test <br/>1.0 I3.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li></ul>\" previous=\"added-diff-3\" changeid=\"changed-diff-3\" next=\"removed-diff-3\">0 </span></a></span></span><span class=\"diff-html-added\" id=\"removed-diff-3\" previous=\"changed-diff-3\" changeid=\"removed-diff-3\" next=\"added-diff-4\">.9b</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"build_all-20170211-235702\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"build_all-20170211-235702 - xUnit Build Test 1.0 I3\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=build_all-20170211-235702\"><span class=\"diff-html-removed\" id=\"added-diff-4\" previous=\"removed-diff-3\" changeid=\"added-diff-4\" next=\"changed-diff-4\">I3</span></a></span></span><br><span style=\"font-weight: bold;\">Test Case:</span><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-25\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-25 - com.polarion.demo.LoginTest.testLogin\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-25\"><span style=\"white-space:nowrap;\"><span class=\"diff-html-changed\" id=\"changed-diff-4\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-36 - Login to the portal.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-25 - <br/>com.polarion.demo.LoginTest.testLogin.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-4\" changeid=\"changed-diff-4\" next=\"changed-diff-5\"><img src=\"/polarion/icons/default/enums/type_test.gif\" md5=\"6a1b2624a1873ab07f5f5932f6c06ae3\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\"></span></span><span style=\"color:#000000;\"><span class=\"diff-html-changed\" id=\"changed-diff-5\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-36 - Login to the portal.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved out of a <b>span</b> with style color:#C0392B;.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-25 - <br/>com.polarion.demo.LoginTest.testLogin.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with style color:#000000;.</li></ul>\" previous=\"changed-diff-4\" changeid=\"changed-diff-5\" next=\"removed-diff-4\">EL-</span></span></a></span></span><span class=\"diff-html-added\" id=\"removed-diff-4\" previous=\"changed-diff-5\" changeid=\"removed-diff-4\" next=\"added-diff-5\">36</span><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-25\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-25 - com.polarion.demo.LoginTest.testLogin\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-25\"><span style=\"color:#000000;\"><span class=\"diff-html-removed\" id=\"added-diff-5\" previous=\"removed-diff-4\" changeid=\"added-diff-5\" next=\"changed-diff-6\">25</span></span><span style=\"white-space: normal\"><span class=\"diff-html-changed\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-36 - Login to the portal.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-25 - <br/>com.polarion.demo.LoginTest.testLogin.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-5\" changeid=\"changed-diff-6\" next=\"removed-diff-5\"></span><span class=\"diff-html-changed\" id=\"changed-diff-6\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-36 - Login to the portal.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-25 - <br/>com.polarion.demo.LoginTest.testLogin.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-5\" changeid=\"changed-diff-6\" next=\"removed-diff-5\">- </span></span></a></span></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"></span><span class=\"diff-html-added\" id=\"removed-diff-5\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Login to the portal<br></span><table style=\"border-collapse: collapse;\"><tbody><tr style=\"color: #757575;\"><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">​</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">#</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Step</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Step Description</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Expected Result</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Actual Result</span></th></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_passed.png\" md5=\"c9b528b9541e127967eda62f79118ef0\" \"=\"\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-removed-image\"></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">1</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Open Login Screen</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Go to E-Library Portal welcome page, right corner, click login</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Login screen with user name and password text fields is displayed</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">​</span></td></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_passed.png\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-removed-image\"></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">2</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Enter False User Details</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">False details: admin/wrong</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">The login button is disabled until both user name and password is entered</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">​</span></td></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-removed-image\"></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">3</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Click \"Login\"</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">​</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Login failed message is shown.</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Null pointer exception when logging to the portal</span></td></tr></tbody></table><table style=\"width: 100%;border-collapse: collapse;max-width: 1280.0px;\"><tbody><tr><th style=\"background-color: #FFFFFF;text-align: left;width: 80%;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Test Case Verdict:</span></th></tr><tr><td style=\"vertical-align: top;\"><span style=\"font-weight: bold;color: #C30000;\"><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-removed-image\"></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\">Failed</span></span><span class=\"diff-html-added\" previous=\"changed-diff-6\" changeid=\"removed-diff-5\" next=\"added-diff-6\"></span></td></tr></tbody></table><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-25\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-25 - com.polarion.demo.LoginTest.testLogin\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-25\"><span style=\"white-space: normal\"><span class=\"diff-html-removed\" id=\"added-diff-6\" previous=\"removed-diff-5\" changeid=\"added-diff-6\" next=\"last-diff\">com.polarion.demo.LoginTest.testLogin</span></span></a></span></span><br><table style=\"margin-bottom: 15px; ;border-collapse: collapse; width:100%; \"><tbody><tr><th style=\"width: 80%; text-align: left; background-color: #ffffff;\"><span class=\"diff-html-removed\" previous=\"removed-diff-5\" changeid=\"added-diff-6\" next=\"last-diff\">Test Case Verdict:</span></th></tr><tr><td style=\"vertical-align: top;\"><span style=\"font-weight: bold;color: #C30000;\"><span class=\"diff-html-removed\" previous=\"removed-diff-5\" changeid=\"added-diff-6\" next=\"last-diff\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" style=\"vertical-align:text-bottom;border:0px;margin-right:2px;\" changetype=\"diff-added-image\"></span><span class=\"diff-html-removed\" previous=\"removed-diff-5\" changeid=\"added-diff-6\" next=\"last-diff\">Failed</span></span><span class=\"diff-html-removed\" previous=\"removed-diff-5\" changeid=\"added-diff-6\" next=\"last-diff\"> junit.framework.AssertionFailedError<br><br>Cannot login as Karl Xavier<br><br>junit.framework.AssertionFailedError: Cannot login as Karl Xavier<br>&nbsp;&nbsp;&nbsp;&nbsp;at junit.framework.Assert.fail(Assert.java:47)<br>&nbsp;&nbsp;&nbsp;&nbsp;at junit.framework.Assert.assertTrue(Assert.java:20)<br>&nbsp;&nbsp;&nbsp;&nbsp;at com.polarion.demo.LoginTest.testLogin(LoginTest.java:12)<br></span></td></tr></tbody></table>"));

    const diffRight = visibleChange.locator(".diff-viewer .diff-leaf.right");
    await expect(diffRight).toBeVisible();
    const diffRightHtml = await diffRight.innerHTML();
    expect(normalizeHtml(diffRightHtml)).toBe(normalizeHtml("<span style=\"font-weight: bold;\">Test Run:</span><span style=\"white-space:nowrap;\"><span class=\"diff-html-removed\" id=\"removed-diff-0\" previous=\"first-diff\" changeid=\"removed-diff-0\" next=\"added-diff-0\"><img src=\"/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\" changetype=\"diff-removed-image\"></span></span><span class=\"diff-html-removed\" previous=\"first-diff\" changeid=\"removed-diff-0\" next=\"added-diff-0\">build</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"0_9b UAT\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"0_9b UAT - User Acceptance Test 0.9b\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=0_9b%20UAT\"><span style=\"white-space:nowrap;\"><span class=\"diff-html-added\" id=\"added-diff-0\" previous=\"removed-diff-0\" changeid=\"added-diff-0\" next=\"changed-diff-0\"><img src=\"/polarion/icons/default/enums/testrun_status_passed.png\" md5=\"c9b528b9541e127967eda62f79118ef0\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\" changetype=\"diff-added-image\"></span></span><span class=\"diff-html-added\" previous=\"removed-diff-0\" changeid=\"added-diff-0\" next=\"changed-diff-0\">0</span><span class=\"diff-html-changed\" id=\"changed-diff-0\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title <br/>build_all-20170211-235702 - xUnit Build Test 1.0 I3.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title 0_9b UAT - User Acceptance Test 0.9b.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-0\" changeid=\"changed-diff-0\" next=\"removed-diff-1\">_</span></a></span></span><span class=\"diff-html-removed\" id=\"removed-diff-1\" previous=\"changed-diff-0\" changeid=\"removed-diff-1\" next=\"added-diff-1\">all</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"0_9b UAT\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"0_9b UAT - User Acceptance Test 0.9b\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=0_9b%20UAT\"><span class=\"diff-html-added\" id=\"added-diff-1\" previous=\"removed-diff-1\" changeid=\"added-diff-1\" next=\"changed-diff-1\">9b UAT </span><span class=\"diff-html-changed\" id=\"changed-diff-1\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title <br/>build_all-20170211-235702 - xUnit Build Test 1.0 I3.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title 0_9b UAT - User Acceptance Test 0.9b.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-1\" changeid=\"changed-diff-1\" next=\"removed-diff-2\">- </span></a></span></span><span class=\"diff-html-removed\" id=\"removed-diff-2\" previous=\"changed-diff-1\" changeid=\"removed-diff-2\" next=\"added-diff-2\">20170211-235702 - xUnit Build </span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"0_9b UAT\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"0_9b UAT - User Acceptance Test 0.9b\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=0_9b%20UAT\"><span class=\"diff-html-added\" id=\"added-diff-2\" previous=\"removed-diff-2\" changeid=\"added-diff-2\" next=\"changed-diff-2\">User Acceptance </span><span class=\"diff-html-changed\" id=\"changed-diff-2\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title <br/>build_all-20170211-235702 - xUnit Build Test 1.0 I3.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title 0_9b UAT - User Acceptance Test 0.9b.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-2\" changeid=\"changed-diff-2\" next=\"removed-diff-3\">Test </span></a></span></span><span class=\"diff-html-removed\" previous=\"changed-diff-2\" changeid=\"removed-diff-3\" next=\"added-diff-3\"></span><span class=\"diff-html-removed\" id=\"removed-diff-3\" previous=\"changed-diff-2\" changeid=\"removed-diff-3\" next=\"added-diff-3\">1</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"0_9b UAT\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"0_9b UAT - User Acceptance Test 0.9b\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=0_9b%20UAT\"><span class=\"diff-html-added\" id=\"added-diff-3\" previous=\"removed-diff-3\" changeid=\"added-diff-3\" next=\"changed-diff-3\">0</span><span class=\"diff-html-changed\" id=\"changed-diff-3\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id <br/>build_all-20170211-235702 and data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup and title <br/>build_all-20170211-235702 - xUnit Build Test 1.0 I3.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=build_all-20170<br/>211-235702 with style font-size:1em;, target _top and <br/>class polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type testRun, data-item-id 0_9b UAT and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup <br/>and title 0_9b UAT - User Acceptance Test 0.9b.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/testrun?id=0_9b%20UAT <br/>with style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-3\" changeid=\"changed-diff-3\" next=\"removed-diff-4\">.</span></a></span></span><span class=\"diff-html-removed\" id=\"removed-diff-4\" previous=\"changed-diff-3\" changeid=\"removed-diff-4\" next=\"added-diff-4\">0 I3</span><span class=\"polarion-rte-link\" data-type=\"testRun\" data-item-id=\"0_9b UAT\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" title=\"0_9b UAT - User Acceptance Test 0.9b\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/testrun?id=0_9b%20UAT\"><span class=\"diff-html-added\" id=\"added-diff-4\" previous=\"removed-diff-4\" changeid=\"added-diff-4\" next=\"changed-diff-4\">9b</span></a></span></span><br><span style=\"font-weight: bold;\">Test Case:</span><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-36\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-36 - Login to the portal\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-36\"><span style=\"white-space:nowrap;\"><span class=\"diff-html-changed\" id=\"changed-diff-4\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-25 - com.polarion.demo.LoginTest.testLogin<br/>.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-36 - Login to <br/>the portal.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-4\" changeid=\"changed-diff-4\" next=\"changed-diff-5\"><img src=\"/polarion/icons/default/enums/type_test.gif\" md5=\"6a1b2624a1873ab07f5f5932f6c06ae3\" \"=\"\" class=\"polarion-Icons\" onmousedown=\"return false;\" contenteditable=\"false\"></span></span><span style=\"color:#C0392B;\"><span class=\"diff-html-changed\" id=\"changed-diff-5\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-25 - com.polarion.demo.LoginTest.testLogin<br/>.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved out of a <b>span</b> with style color:#000000;.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-36 - Login to <br/>the portal.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with style color:#C0392B;.</li></ul>\" previous=\"changed-diff-4\" changeid=\"changed-diff-5\" next=\"removed-diff-5\">EL-</span></span></a></span></span><span class=\"diff-html-removed\" id=\"removed-diff-5\" previous=\"changed-diff-5\" changeid=\"removed-diff-5\" next=\"added-diff-5\">25</span><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-36\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-36 - Login to the portal\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-36\"><span style=\"color:#C0392B;\"><span class=\"diff-html-added\" id=\"added-diff-5\" previous=\"removed-diff-5\" changeid=\"added-diff-5\" next=\"changed-diff-6\">36</span></span><span style=\"white-space: normal\"><span class=\"diff-html-changed\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-25 - com.polarion.demo.LoginTest.testLogin<br/>.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-36 - Login to <br/>the portal.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-5\" changeid=\"changed-diff-6\" next=\"removed-diff-6\"></span><span class=\"diff-html-changed\" id=\"changed-diff-6\" changes=\"<ul class='changelist'><li>Moved out of a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-25 and <br/>data-option-id long.</li><li>Moved out of a <b>span</b> with class <br/>polarion-no-style-cleanup, style white-space:nowrap; <br/>and title EL-25 - com.polarion.demo.LoginTest.testLogin<br/>.</li><li>Moved out of a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-25 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li><li>Moved to a <b>span</b> with class polarion-rte-link, <br/>data-type workItem, data-item-id EL-36 and <br/>data-option-id long.</li><li>Moved to a <b>span</b> with class polarion-no-style-cleanup, <br/>style white-space:nowrap; and title EL-36 - Login to <br/>the portal.</li><li>Moved to a <b>link</b> with destination <br/>/polarion/#/project/elibrary/workitem?id=EL-36 with <br/>style font-size:1em;, target _top and class <br/>polarion-Hyperlink.</li></ul>\" previous=\"added-diff-5\" changeid=\"changed-diff-6\" next=\"removed-diff-6\">- </span></span></a></span></span><span class=\"diff-html-removed\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\"></span><span class=\"diff-html-removed\" id=\"removed-diff-6\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\">com.polarion.demo.LoginTest.testLogin<br></span><span class=\"diff-html-removed\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\">Test Case Verdict:</span><span style=\"font-weight: bold;color: #C30000;\"><span class=\"diff-html-removed\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" style=\"vertical-align:text-bottom;border:0px;margin-right:2px;\" changetype=\"diff-removed-image\"></span><span class=\"diff-html-removed\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\">Failed</span></span><span class=\"diff-html-removed\" previous=\"changed-diff-6\" changeid=\"removed-diff-6\" next=\"added-diff-6\"> junit.framework.AssertionFailedError<br>Cannot login as Karl Xavier<br>junit.framework.AssertionFailedError: Cannot login as Karl Xavier<br>&nbsp;&nbsp;&nbsp;&nbsp;at junit.framework.Assert.fail(Assert.java:47)<br>&nbsp;&nbsp;&nbsp;&nbsp;at junit.framework.Assert.assertTrue(Assert.java:20)<br>&nbsp;&nbsp;&nbsp;&nbsp;at com.polarion.demo.LoginTest.testLogin(LoginTest.java:12)<br></span><span class=\"polarion-rte-link\" data-type=\"workItem\" data-item-id=\"EL-36\" data-option-id=\"long\"><span class=\"polarion-no-style-cleanup\" style=\"white-space:nowrap;\" title=\"EL-36 - Login to the portal\"><a style=\"font-size:1em;\" target=\"_top\" class=\"polarion-Hyperlink\" href=\"/polarion/#/project/elibrary/workitem?id=EL-36\"><span style=\"white-space: normal\"><span class=\"diff-html-added\" id=\"added-diff-6\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Login to the portal</span></span></a></span></span><br><table style=\"border-collapse: collapse;\"><tbody><tr style=\"color: #757575;\"><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">​</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">#</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Step</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Step Description</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Expected Result</span></th><th style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Actual Result</span></th></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_passed.png\" md5=\"c9b528b9541e127967eda62f79118ef0\" \"=\"\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-added-image\"></span><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">1</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Open Login Screen</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Go to E-Library Portal welcome page, right corner, click login</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Login screen with user name and password text fields is displayed</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">​</span></td></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_passed.png\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-added-image\"></span><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">2</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Enter False User Details</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">False details: admin/wrong</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">The login button is disabled until both user name and password is entered</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">​</span></td></tr><tr><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" md5=\"42492684e24356a4081134894eabeb9e\" \"=\"\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-added-image\"></span><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"></span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">3</span></td><td style=\"font-weight: bold;background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Click \"Login\"</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">​</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Login failed message is shown.</span></td><td style=\"background-color: #FFFFFF;text-align: left;vertical-align: top;padding: 10px;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Null pointer exception when logging to the portal</span></td></tr></tbody></table><table style=\"width: 100%;border-collapse: collapse;max-width: 1280.0px;\"><tbody><tr><th style=\"background-color: #FFFFFF;text-align: left;width: 80%;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Test Case Verdict:</span></th></tr><tr><td style=\"vertical-align: top;\"><span style=\"font-weight: bold;color: #C30000;\"><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"><img src=\"http://localhost/polarion/icons/default/enums/testrun_status_failed.png\" style=\"margin-right: 2px;border: 0px;\" changetype=\"diff-added-image\"></span><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\">Failed</span></span><span class=\"diff-html-added\" previous=\"removed-diff-6\" changeid=\"added-diff-6\" next=\"last-diff\"></span></td></tr></tbody></table>"));
  });

  test("wi-pairs merge request canceled", async ({ page }) => {
    let requestWasMade = false;

    await page.route('**/merge/workitems', route => {
      requestWasMade = true;
      route.continue();
    });

    await page.waitForSelector('.header .merge-pane', { state: 'visible' });
    await closeModalIfVisible(page, 'redundancy-modal', 'button:has-text("Close")');
    await handleMergeRequest(page, 'EL-16-header', 0, false);

    expect(requestWasMade).toBe(false);
  });

  test("wi-pairs merge request confirmed", async ({ page }) => {
    let requestWasMade = false;

    await page.route('**/merge/workitems', route => {
      requestWasMade = true;
      route.continue();
    });

    await page.waitForSelector('.header .merge-pane', { state: 'visible' });
    await closeModalIfVisible(page, 'redundancy-modal', 'button:has-text("Close")');
    await handleMergeRequest(page, 'EL-16-header', 0, true);

    expect(requestWasMade).toBe(true);
  });
});
